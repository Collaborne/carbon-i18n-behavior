<!doctype html>
<link rel="import" href="../polymer/polymer.html">

<script>
	var Polymer = Polymer || {};
	Polymer.CarbonI18nBehaviorLocales = Polymer.CarbonI18nBehaviorLocales || {
		/**
		 * Adds the translations for a locale
		 *
		 * @param {String} localname Name of the element for which the translations
		 *   are registered, e.g. `x-hello`
		 * @param {String} locale Name of the locale for the translations, e.g. `de`
		 * @param {String} translations Translations for the given locale, e.g. { hello: `Hallo` }
		 */
		add: function(localName, locale, translations) {
			this[localName] = this[localName] || {};
			this[localName][locale] = translations;
		}
	};

	/**
	 * Adds internationalization support to an element
	 *
	 * @polymerBehavior Polymer.CarbonI18nBehavior
	 * @demo demo/index.html
	 */
	Polymer.CarbonI18nBehavior = {
		properties: {
			/**
			 * The currently selected locale.
			 *
			 * The default value is the language of the browser (`navigator.language`).
			 */
			// FIXME: Yes, this component is mixing up languages and locales!
			locale: {
				type: String,
				value: navigator.language,
				observer: '_onChangedLocale'
			},

			/**
			 * The locale to use when a specific element has no translations available in the selected `locale`.
			 *
			 * The default value is `en`.
			 */
			fallbackLocale: {
				type: String,
				value: 'en'
			},

			/** Exposes all translations */
			i18n: Object
		},

		ready: function() {
			// Trigger initial load
			this._onChangedLocale(this.locale);
		},

		/**
		 * Returns localized text with replaced placeholders
		 *
		 * @param {Object} i18n Polymer data binding requires the parameter
		 *   to trigger a reload whenever the locale changes.
		 * @param {String} key Key under which the translation is stored
		 */
		i18nFormat: function(i18n, key) {
			var args = Array.prototype.slice.call(arguments, 2);
			return this._format(i18n[key], args);
		},

		_onChangedLocale: function(locale) {
			var elementLocales = Polymer.CarbonI18nBehaviorLocales[this.localName];
			// Fall back to 'en' if we don't have translations for the specific locale.
			// TODO: We should at least try to check for parents, for example 'en-CA' might not be available, but 'en' would be.
			this.i18n = elementLocales[locale] || elementLocales[this.fallbackLocale];
		},

		/**
		 * Simple version of formatf
		 */
		_format: function(format, args) {
			return format.replace(/{(\d+)}/g, function(match, number) {
				return typeof args[number] != 'undefined' ? args[number] : match;
			});
		}
	};
</script>
