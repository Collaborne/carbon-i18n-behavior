<!doctype html>
<link rel="import" href="../polymer/polymer.html">

<script>
	var Polymer = Polymer || {};
	Polymer.CarbonI18nBehaviorLocales = Polymer.CarbonI18nBehaviorLocales || {
		/**
		 * Adds the translations for a locale
		 *
		 * @param {String} localname Name of the element for which the translations
		 *   are registered, e.g. `x-hello`
		 * @param {String} locale Name of the locale for the translations, e.g. `de`
		 * @param {String} translations Translations for the given locale, e.g. { hello: `Hallo` }
		 */
		add: function(localName, locale, translations) {
			this[localName] = this[localName] || {};
			this[localName][locale.toLowerCase()] = translations;
		}
	};

	// Private shared database of all elements that use CarbonI18nBehavior
    var carbonI18nBehaviorElements = [];

	// Locale used by all existing i18n elements (required to initialize new elements)
	// Work out a reasonable default
	// See http://gu.illau.me/posts/the-problem-of-user-language-lists-in-javascript/ for a discussion
	var carbonI18nBehaviorLocale = navigator.language || navigator.userLanguage || navigator.browserLanguage || navigator.systemLanguage;

	/**
	 * Adds internationalization support to an element
	 *
	 * @polymerBehavior Polymer.CarbonI18nBehavior
	 * @demo demo/index.html
	 */
	Polymer.CarbonI18nBehavior = {
		properties: {
			/**
			 * The currently selected locale.
			 *
			 * The default value is the language of the browser (`navigator.language`).
			 */
			// FIXME: Yes, this component is mixing up languages and locales!
			locale: {
				type: String,
				value: function() {
					// Use current locale used by the other i18n elements
					return carbonI18nBehaviorLocale;
				},
				observer: '_onLocaleChanged'
			},

			/**
			 * The locale to use when a specific element has no translations available in the selected `locale`.
			 *
			 * The default value is `en`.
			 */
			fallbackLocale: {
				type: String,
				value: 'en'
			},

			/** Exposes all translations */
			i18n: {
				type: Object,
				computed: '_computeI18n(locale, fallbackLocale)'
			}
		},

		attached: function() {
			carbonI18nBehaviorElements.push(this);
		},
		detached: function() {
			var i = carbonI18nBehaviorElements.indexOf(this);
			if (i >= 0) {
				carbonI18nBehaviorElements.splice(i, 1);
			}
		},

		/**
		 * Returns localized text with replaced placeholders
		 *
		 * @param {Object} i18n Polymer data binding requires the parameter
		 *   to trigger a reload whenever the locale changes.
		 * @param {String} key Key under which the translation is stored
		 */
		i18nFormat: function(i18n, key) {
			var args = Array.prototype.slice.call(arguments, 2);
			return this._format(i18n[key], args);
		},

		_computeI18n: function(locale, fallbackLocale) {
			var elementLocales = Polymer.CarbonI18nBehaviorLocales[this.localName];
			// Try to find a suitable locale for which we have data.
			var result = undefined;
			while (locale) {
				result = elementLocales[locale.toLowerCase()];
				if (result) {
					break;
				} else {
					locale = locale.substring(0, locale.lastIndexOf('-'));
				}
			}

			if (!result) {
				result = elementLocales[fallbackLocale.toLowerCase()];
			}
			return result;
		},

		/**
		 * Inform other elements with the behavior about the changed locale
		 */
		_onLocaleChanged: function(locale) {
			if (!locale) {
				return;
			}

			carbonI18nBehaviorLocale = locale;
			carbonI18nBehaviorElements.forEach(function(el) {
				if (el.locale !== locale) {
			    	el.locale = locale;
				}
		    });
		},

		/**
		 * Simple version of formatf
		 */
		_format: function(format, args) {
			return format.replace(/{(\d+)}/g, function(match, number) {
				return typeof args[number] != 'undefined' ? args[number] : match;
			});
		}
	};
</script>
